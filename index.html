<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Studie – Textauswahl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, system-ui, sans-serif;
      padding: 1.5rem;
      line-height: 1.4;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.8rem;
    }
    button {
      font-size: 1.05rem;
      padding: 0.8rem 1rem;
      margin: 0.3rem 0;
      width: 100%;
      border-radius: 0.6rem;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
    }
    button.small {
      font-size: 0.85rem;
      padding: 0.5rem 0.7rem;
      width: auto;
      margin-top: 0.8rem;
    }
    input[type="text"] {
      font-size: 1.05rem;
      padding: 0.6rem 0.8rem;
      width: 100%;
      box-sizing: border-box;
      margin: 0.3rem 0 0.5rem 0;
      border-radius: 0.4rem;
      border: 1px solid #ccc;
    }
    .hidden {
      display: none;
    }
    .box {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 0.6rem;
      border: 1px solid #ddd;
      background: #fafafa;
    }
    .code-box {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 0.6rem;
      border: 1px dashed #aaa;
      background: #fff;
    }
    .code-display {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0.2rem 0 0.4rem 0;
      word-break: break-all;
    }
    .small-text {
      font-size: 0.85rem;
      color: #555;
    }
    #adminArea {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #ddd;
    }
    #logOutput {
      white-space: pre;
      font-family: Menlo, monospace;
      font-size: 0.85rem;
      overflow-x: auto;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>

<h1>Studie – Texte</h1>

<div id="introArea" class="box">
  <p>
    Bitte lassen Sie <strong>jede Versuchsperson ihren anonymen Studiencode</strong>
    eingeben (denselben Code, der auch im SoSci-Fragebogen verwendet wird).
  </p>
  <label for="codeInput"><strong>Studiencode eingeben:</strong></label>
  <input id="codeInput" type="text" autocomplete="off" autocapitalize="none" spellcheck="false" />
  <button id="confirmCodeBtn">Code bestätigen</button>
  <p class="small-text">
    Hinweis: Wenn derselbe Code später erneut eingegeben wird, wird automatisch
    dieselbe Textvariante verwendet (Gain, Loss oder Neutral). Die Zuordnung
    bleibt für die Auswertung gespeichert.
  </p>
</div>

<div id="stationArea" class="box hidden">
  <p>
    Die aktuelle Versuchsperson kann nun in der Ausstellung an den
    Stationen die Texte öffnen:
  </p>

  <button onclick="openPdf(1)">Text an Station 1 öffnen</button>
  <button onclick="openPdf(2)">Text an Station 2 öffnen</button>
  <button onclick="openPdf(3)">Text an Station 3 öffnen</button>

  <div class="code-box">
    <p><strong>Studiencode dieser Person:</strong></p>
    <p id="codeDisplay" class="code-display"></p>
    <p class="small-text">
      Dieser Code wird im SoSci-Fragebogen eingetragen. Die tatsächliche
      Variante (Gain/Loss/Neutral) ist hier nicht sichtbar und kann erst in
      der Auswertung über den Admin-Bereich rekonstruiert werden.
    </p>
  </div>

  <button id="resetBtn" class="small">
    Versuchsperson beendet – für nächste Person zurücksetzen
  </button>
</div>

<div id="adminArea" class="hidden">
  <h2>Admin-Bereich (nur nach Datenerhebung benutzen)</h2>
  <p class="small-text">
    Unten stehen alle bisher verwendeten Studiencodes mit ihrer (numerischen)
    Bedingung. Format: <code>CODE;BEDINGUNG</code>.
    <br>
    Beispiel: 1 = Gain, 2 = Loss, 3 = Neutral (die genaue Zuordnung kannst du
    in der Auswertung festlegen bzw. dokumentieren).
  </p>
  <div id="logOutput"></div>
  <button id="clearLogBtn" class="small">
    Kompletten Log aus localStorage löschen
  </button>
</div>

<script>
  let condition = null;      // 1 = Gain, 2 = Loss, 3 = Neutral
  let currentCode = null;
  let frameLog = [];

  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function loadLog() {
    try {
      const raw = localStorage.getItem('frameLog');
      if (raw) {
        frameLog = JSON.parse(raw);
        if (!Array.isArray(frameLog)) frameLog = [];
      } else {
        frameLog = [];
      }
    } catch (e) {
      frameLog = [];
    }
  }

  function saveLog() {
    localStorage.setItem('frameLog', JSON.stringify(frameLog));
  }

  function confirmCode() {
    const input = document.getElementById('codeInput');
    const code = (input.value || '').trim();

    if (!code) {
      alert('Bitte geben Sie einen gültigen Studiencode ein.');
      return;
    }

    currentCode = code;

    // Prüfen, ob Code schon existiert
    let entry = frameLog.find(e => e.code === currentCode);

    if (entry) {
      // Bereits vorhandene Bedingung verwenden
      condition = entry.condition;
    } else {
      // Neue Bedingung zufällig zuweisen
      condition = randomInt(1, 3); // 1=Gain, 2=Loss, 3=Neutral
      entry = { code: currentCode, condition: condition };
      frameLog.push(entry);
      saveLog();
    }

    // UI aktualisieren
    document.getElementById('stationArea').classList.remove('hidden');
    document.getElementById('codeDisplay').textContent = currentCode;

    // Optional: Eingabefeld leeren, aber Code anzeigen lassen
    input.value = '';
  }

  function resetParticipant() {
    condition = null;
    currentCode = null;
    document.getElementById('codeDisplay').textContent = '';
    document.getElementById('stationArea').classList.add('hidden');
  }

  function openPdf(stationNumber) {
    if (!condition) {
      alert('Bitte zuerst einen Studiencode eingeben.');
      return;
    }

    let path = '';

    // Dateinamen-Schema:
    // pdfs/gain_1.pdf, pdfs/gain_2.pdf, pdfs/gain_3.pdf usw.
    if (condition === 1) {           // Gain
      path = 'pdfs/gain_' + stationNumber + '.pdf';
    } else if (condition === 2) {    // Loss
      path = 'pdfs/loss_' + stationNumber + '.pdf';
    } else if (condition === 3) {    // Neutral
      path = 'pdfs/neutral_' + stationNumber + '.pdf';
    }

    // Lokale PDF im gleichen Ordner öffnen
    window.location.href = path;
  }

  function renderAdminLog() {
    const out = document.getElementById('logOutput');
    if (!out) return;
    if (!frameLog.length) {
      out.textContent = 'Noch keine Einträge vorhanden.';
      return;
    }
    let text = 'CODE;BEDINGUNG\n';
    frameLog.forEach(entry => {
      text += `${entry.code};${entry.condition}\n`;
    });
    out.textContent = text;
  }

  // Initialisierung
  loadLog();

  // Event-Listener
  document.getElementById('confirmCodeBtn').addEventListener('click', confirmCode);
  document.getElementById('resetBtn').addEventListener('click', resetParticipant);

  // Enter-Taste im Eingabefeld erlauben
  document.getElementById('codeInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      confirmCode();
    }
  });

  // Admin-Bereich nur zeigen, wenn ?admin=1 in der URL steht
  if (window.location.search.includes('admin=1')) {
    const admin = document.getElementById('adminArea');
    admin.classList.remove('hidden');
    renderAdminLog();

    document.getElementById('clearLogBtn').addEventListener('click', () => {
      if (confirm('Log wirklich komplett löschen? Dies sollte erst nach der Datenauswertung geschehen.')) {
        frameLog = [];
        saveLog();
        renderAdminLog();
      }
    });
  }
</script>

</body>
</html>
