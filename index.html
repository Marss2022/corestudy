<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Studietexte</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    padding: 1.5rem;
    max-width: 900px;
    margin: 0 auto;
    line-height: 1.45;
  }
  h1 {
    font-size: 1.6rem;
    margin-bottom: 1rem;
  }
  .box {
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 0.6rem;
    padding: 1rem;
    margin-top: 1rem;
  }
  button {
    display: block;
    width: 100%;
    padding: 1rem;
    margin: 0.4rem 0;
    font-size: 1.1rem;
    border-radius: 0.7rem;
    color: white;
    border: none;
    cursor: pointer;
  }
  .b1 { background: #4285F4; }   /* Blau */
  .b2 { background: #34A853; }   /* Grün */
  .b3 { background: #FB8C00; }   /* Orange */

  .back-btn {
    background: #555;
    width: auto;
    padding: 0.7rem 1.2rem;
    font-size: 1rem;
    margin-top: 1rem;
    border-radius: 0.6rem;
    color: white;
  }

  input[type="text"] {
    width: 100%;
    padding: 0.8rem;
    font-size: 1.1rem;
    border-radius: 0.6rem;
    border: 1px solid #bbb;
    margin-bottom: 0.6rem;
  }

  .hidden { display: none; }

  #pdfViewer {
    width: 100%;
    height: 80vh;
    border: 1px solid #ccc;
    margin-top: 1rem;
  }

  .small-text {
    font-size: 0.88rem;
    color: #555;
  }

  .code-display {
    font-weight: bold;
    font-size: 1.2rem;
  }
</style>
</head>

<body>

<h1>Studientexte</h1>

<!-- Introbereich -->
<div id="introArea" class="box">
  <p>Bitte geben Sie hier Ihren Studiencode ein.</p>

  <p class="small-text">
    Ihr Studiencode setzt sich wie folgt zusammen:
  </p>
  <ul class="small-text">
    <li>den ersten zwei Buchstaben Ihres Geburtsortes,</li>
    <li>den letzten zwei Ziffern Ihres Geburtsjahres und</li>
    <li>den letzten zwei Ziffern Ihrer Hausnummer (Beispiel: Hausnummer 1 → 01).</li>
  </ul>
  <p class="small-text"><strong>Beispiel:</strong> Berlin, 1985, Hausnummer 12 → <em>BE8512</em></p>

  <input id="codeInput" type="text" autocomplete="off" autocapitalize="none" placeholder="Studiencode eingeben">
  <button id="confirmCodeBtn" class="b1">Studiencode bestätigen</button>
  <p id="statusText" class="small-text"></p>
</div>

<!-- Stations-Bereich -->
<div id="stationArea" class="box hidden">
  <p>Sie können nun die Texte an den folgenden Stationen öffnen:</p>

  <button class="b1" onclick="openPdf(1)">Text öffnen bei <em>Gebäude und Siedlungen</em></button>
  <button class="b2" onclick="openPdf(2)">Text öffnen bei <em>Textilien</em></button>
  <button class="b3" onclick="openPdf(3)">Text öffnen bei <em>Riffe der Gegenwart</em></button>

  <div class="box" style="margin-top:1rem; background:white;">
    <p><strong>Ihr Studiencode:</strong></p>
    <p id="codeDisplay" class="code-display"></p>
    <p class="small-text">Dieser Code wird auch im Fragebogen eingetragen.</p>
  </div>

  <button class="back-btn" onclick="resetParticipant()">Studienvorgang beenden</button>
</div>

<!-- PDF-Bereich -->
<div id="pdfArea" class="box hidden">
  <p><strong>Textansicht:</strong></p>
  <iframe id="pdfViewer"></iframe>
  <button class="back-btn" onclick="returnToMenu()">Zurück zur Auswahl</button>
</div>

<script>
/* ---------------------------------
   Passwortschutz
---------------------------------- */
const ACCESS_PASSWORD = "Museum";
let ACCESS_GRANTED = true;

(function () {
  if (!sessionStorage.getItem("access_ok")) {
    let ok = false, attempts = 0;
    while (!ok && attempts < 3) {
      const p = prompt("Bitte geben Sie das Studienpasswort ein:");
      if (p === ACCESS_PASSWORD) {
        ok = true;
        sessionStorage.setItem("access_ok", "1");
      } else {
        attempts++;
        alert("Passwort falsch.");
      }
    }
    if (!ok) {
      ACCESS_GRANTED = false;
      document.body.innerHTML =
        "<p style='padding:1.5rem;'>Zugriff verweigert.</p>";
    }
  }
})();

/* ---------------------------------
   Nur starten, wenn Zugriff erlaubt
---------------------------------- */
if (ACCESS_GRANTED) {

  const SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbwyYsAM9KsAaPPklixaMA_1AmPSI4k6cx-3wCMll4Au4lwca5YHc-5srS6pUC14yPxYZQ/exec";

  let currentCode = null;
  let condition = null;

  async function fetchCondition(code) {
    const res = await fetch(SCRIPT_URL + "?code=" + encodeURIComponent(code));
    if (!res.ok) throw new Error("Fehler bei Serveranfrage");
    const data = await res.json();
    if (!data.success) throw new Error("Zuteilung nicht erfolgreich");
    return data.condition;
  }

  async function confirmCode() {
    const input = document.getElementById("codeInput");
    const code = input.value.trim();
    const status = document.getElementById("statusText");

    if (!code) {
      alert("Bitte geben Sie einen gültigen Studiencode ein.");
      return;
    }

    status.textContent = "Code wird geprüft …";

    try {
      condition = await fetchCondition(code);
      currentCode = code;

      document.getElementById("stationArea").classList.remove("hidden");
      document.getElementById("codeDisplay").textContent = currentCode;
      document.getElementById("pdfArea").classList.add("hidden");

      status.textContent = "Studiencode akzeptiert.";
      input.value = "";

    } catch (err) {
      console.error(err);
      alert("Es gab ein Problem bei der Zuteilung. Bitte wenden Sie sich an das Studienpersonal.");
      status.textContent = "Zuteilung fehlgeschlagen.";
    }
  }

  function openPdf(station) {
    if (!condition) {
      alert("Bitte zuerst Ihren Studiencode eingeben.");
      return;
    }

    let path = "";
    if (condition === 1) path = `pdfs/gain_${station}.pdf`;
    if (condition === 2) path = `pdfs/loss_${station}.pdf`;
    if (condition === 3) path = `pdfs/neutral_${station}.pdf`;

    document.getElementById("stationArea").classList.add("hidden");
    document.getElementById("pdfArea").classList.remove("hidden");
    document.getElementById("pdfViewer").src = path;
  }

  function returnToMenu() {
    document.getElementById("pdfArea").classList.add("hidden");
    document.getElementById("stationArea").classList.remove("hidden");
    document.getElementById("pdfViewer").src = "";
  }

  function resetParticipant() {
    currentCode = null;
    condition = null;
    document.getElementById("stationArea").classList.add("hidden");
    document.getElementById("pdfArea").classList.add("hidden");
    document.getElementById("statusText").textContent = "";
  }

  document.getElementById("confirmCodeBtn").onclick = confirmCode;
  document.getElementById("codeInput").addEventListener("keypress", e => {
    if (e.key === "Enter") confirmCode();
  });

}
</script>

</body>
</html>

